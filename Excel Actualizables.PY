import os
import time
import psutil
import win32com.client
import calendar
from datetime import datetime, timedelta

# ğŸ“Œ Obtener la fecha actual y calcular el mes anterior
hoy = datetime.today()
fecha_mes_anterior = hoy.replace(day=1) - timedelta(days=1)

# ğŸ”¹ Diccionario para convertir nombres de mes al espaÃ±ol
meses_es = {
    "January": "Enero", "February": "Febrero", "March": "Marzo", "April": "Abril",
    "May": "Mayo", "June": "Junio", "July": "Julio", "August": "Agosto",
    "September": "Septiembre", "October": "Octubre", "November": "Noviembre", "December": "Diciembre"
}

mes_actual = hoy.month
mes_actual_nombre = meses_es[calendar.month_name[hoy.month]]
anio_actual = hoy.year


# ğŸ“Œ ConstrucciÃ³n dinÃ¡mica de nombres de archivos
#BEETRACK_MES_ACTUAL = rf"C:\Users\Administrador\Clinical Market\Control GestiÃ³n - Documentos\Respaldo Vistas\{anio_actual}\Transporte\Beetrack\{mes_actual}-{mes_actual_nombre}.xlsx"

# ğŸ“Œ Lista de archivos de Excel con mes dinÃ¡mico
archivos_excel = [
    rf"C:\Users\Administrador\Clinical Market\Control GestiÃ³n - Documentos\Respaldo Vistas\{anio_actual}\Transporte\Beetrack\{mes_actual}-{mes_actual_nombre}.xlsx",
    r"C:\Users\Administrador\Clinical Market\Control GestiÃ³n - Documentos\Power BI\Tablas\Alerta_MONTO_OC.xlsx",
    r"C:\Users\Administrador\Clinical Market\Control GestiÃ³n - Documentos\Power BI\Tablas\Detalle_Alertas_Facturacion_CMK_PROFAR.xlsx",
    r"C:\Users\Administrador\Clinical Market\Control GestiÃ³n - Documentos\Power BI\Tablas\Ventas_B2B_Alertas.xlsx",
    r"C:\Users\Administrador\Clinical Market\Control GestiÃ³n - Documentos\Power BI\Tablas\Bodegas_Detalle.xlsx",
    r"C:\Users\Administrador\Clinical Market\Control GestiÃ³n - Documentos\Power BI\Tablas\SKU_ECOMMERCE.xlsx"
    
]

# ğŸ“Œ Cerrar cualquier instancia previa de Excel (forzado, sin validaciÃ³n)
print("âŒ Cerrando todas las instancias de Excel (forzado)...")
os.system("taskkill /IM EXCEL.EXE /F")
time.sleep(5)  # Esperar a que Excel se cierre completamente

# ğŸ“Œ Iniciar Excel en segundo plano
print("ğŸš€ Iniciando Excel en segundo plano...")
excel = win32com.client.Dispatch("Excel.Application")
excel.Visible = True  # Mantener Excel en segundo plano

# ğŸ“Œ Intentar abrir los archivos con reintentos en caso de error
workbooks = []
max_retries = 3  # NÃºmero mÃ¡ximo de intentos
retry_wait = 5  # Tiempo de espera entre intentos en segundos

for archivo in archivos_excel:
    if os.path.exists(archivo):
        intentos = 0
        while intentos < max_retries:
            try:
                print(f"ğŸ“‚ Intentando abrir {os.path.basename(archivo)}... (Intento {intentos + 1}/{max_retries})")
                wb = excel.Workbooks.Open(archivo)
                workbooks.append(wb)
                time.sleep(2)  # Evita que Excel colapse por abrir varios archivos simultÃ¡neamente
                break  # Si se abre correctamente, salimos del bucle
            except Exception as e:
                print(f"âš ï¸ Error al abrir {os.path.basename(archivo)}: {e}")
                intentos += 1
                time.sleep(retry_wait)  # Esperar antes de reintentar

        if intentos == max_retries:
            print(f"âŒ No se pudo abrir {os.path.basename(archivo)} despuÃ©s de {max_retries} intentos.")

# â³ Esperar 180 segundos antes de actualizar con contador
print("âŒ› Esperando 15 segundos antes de actualizar los archivos...")
for i in range(15, 0, -1):
    print(f"\râ³ Tiempo restante: {i} segundos", end="", flush=True)
    time.sleep(1)
print("\nâœ… Listo para actualizar.")

# ğŸ“Œ Ordenar actualizaciÃ³n en todos los archivos abiertos
for wb in workbooks:
    archivo_nombre = os.path.basename(wb.FullName)
    print(f"ğŸ”„ Dando la orden de actualizaciÃ³n en {archivo_nombre}...")
    try:
        wb.RefreshAll()
    except Exception as e:
        print(f"âš ï¸ Error al actualizar {archivo_nombre}: {e}")

# â³ Esperar 5 minutos antes de cerrar los archivos con contador
print("âŒ› Esperando 3 minutos para completar la actualizaciÃ³n...")
for i in range(180, 0, -1):
    minutos = i // 60
    segundos = i % 60
    print(f"\râ³ Tiempo restante: {minutos:02}:{segundos:02} minutos", end="", flush=True)
    time.sleep(1)
print("\nâœ… Todos los archivos han completado la actualizaciÃ³n.")

# ğŸ“Œ Guardar y cerrar cada archivo uno por uno
for wb in workbooks:
    archivo_nombre = os.path.basename(wb.FullName)
    try:
        wb.Save()
        print(f"âœ… {archivo_nombre} guardado.")
        wb.Close()
        print(f"âŒ {archivo_nombre} cerrado.")
    except Exception as e:
        print(f"âš ï¸ Error al cerrar {archivo_nombre}: {e}")

# ğŸ“Œ Cerrar Excel completamente al final (forzado, sin validaciÃ³n)
print("âŒ Cerrando Excel en segundo plano (forzado)...")
os.system("taskkill /IM EXCEL.EXE /F")
print("âœ… Proceso completado.")